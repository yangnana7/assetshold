### **BDD設計書：ローカル資産ポートフォリオアプリ**

**TO:** ClaudeCode
**FROM:** あなた (Project Owner)
**DATE:** 2025/08/10
**SUBJECT:** 【最終仕様】資産ポートフォリオアプリ単独開発のためのBDD設計書

このドキュメントは、「ローカル資産ポートフォリオアプリ」の開発を円滑に進めるための、最終FIX版の振る舞い駆動開発（BDD）仕様書です。ここに定義されたルールとシナリオに厳密に従って、開発を進めてください。

***

### **1. 開発の基本情報とシステム要件**

* **目的:** 株式、時計、不動産など多様な個人資産を、外部に依存しない**完全ローカル環境**で安全に管理・評価・可視化する。
* **ソースコード担当:** **ClaudeCode**
* **受け入れテスト担当:** **あなた**
* **技術スタック:**
    * Backend: Node.js + Express
    * Database: **SQLite** (`data/portfolio.db`)
    * Frontend: React + Vite
* **最重要システム規約:**
    * **ポート規約:** サーバーのポート番号は **`3009` に完全固定**する。環境変数等で `3009` 以外のポートが指定された場合、サーバーはエラーを出力して**起動に失敗しなければならない (MUST FAIL)**。
    * **データ規約:** `note`（備考）フィールドは、ユーザーによる入力がない場合、`null` や `undefined` ではなく、**空文字列 `""` として保存**する。

***

### **2. ユーザー認証とアクセス制御**

**フィーチャー:** ユーザーの役割に基づき、アプリの機能へのアクセスを厳密に制御する。

#### **シナリオ: 未ログイン状態でのアクセス**

* **Given:** ユーザーが未ログイン状態でアプリのURL (`http://assets.local`) に初めてアクセスする。
* **When:** ページが読み込まれる。
* **Then:**
    * データが表示された**閲覧専用のダッシュボード**が表示される。
    * 画面の右上隅に「ログイン」ボタンのみが表示される。
    * 資産の追加・編集・削除など、データを変更するUIは一切表示されない。

#### **シナリオ: APIレベルでのアクセスブロック**

* **Given:** 未ログインのユーザーがいる。
* **When:** 悪意のあるユーザーがツールを使い、資産追加API（例: `POST /api/assets`）を直接呼び出す。
* **Then:** サーバーはリクエストを拒否し、ステータスコード **`401 Unauthorized`** を返さなければならない。

#### **シナリオ: `admin`ユーザーのログイン**

* **Given:** `admin`ユーザーがログイン画面にいる。
* **When:** 正しい認証情報でログインする。
* **Then:**
    * 画面上部に「資産一覧」「一括インポート」などのナビゲーションが表示される。
    * データの追加・編集・削除など、全ての機能が利用可能になる。

***

### **3. 資産の記録・編集・削除**

**フィーチャー:** 資産データを正確に記録、部分更新、削除できる。

#### **シナリオ: `note`（備考）付きで新しい資産を記録する**

* **Given:** `admin`ユーザーがログインしている。
* **When:** ユーザーが必須項目に加え、「備考(`note`)」に `2025年購入の保証書付き` と入力して登録する。
* **Then:** 資産リストの新しい記録に「備考」として `2025年購入の保証書付き` が表示され、データベースにも空文字列ではない値で保存される。

#### **シナリオ: `note`（備考）だけを部分更新する**

* **Given:** `note`が空欄の既存の資産記録があり、`admin`ユーザーが編集モードに入っている。
* **When:** ユーザーがその記録の備考欄のみに `外箱に傷あり` と入力し、「保存」ボタンをクリックする。
* **Then:**
    * サーバーに対して **`PATCH` メソッド**でリクエストが送信される。
    * データベースの該当レコードは、他の項目（取得日、簿価など）を**保持したまま**、`note` のみが `外箱に傷あり` に更新される。
    * ページを再読み込みしても、更新された備考が表示され続ける。

#### **シナリオ: 資産記録を安全に削除する**

* **Given:** `admin`ユーザーが編集モードに入っている。
* **When:** ユーザーが任意の記録の「削除」ボタンを押し、確認ダイアログで「OK」をクリックする。
* **Then:** その記録はデータベースから完全に削除され、画面からも消える。監査ログ(`audit_log`)には削除の記録が残る。

***

### **4. データ連携 (CSVファイル同期)**

**フィーチャー:** CSVファイルをデータの**正本 (Canonical Source)** とし、アプリへの一括データ同期を行う。

#### **シナリオ: 管理者がCSVファイルを手動でアップロードしてインポートする**

* **Given:** `admin`ユーザーがログインし、「一括インポート」画面を開いている。
* **And:** ユーザーは、所定のヘッダーとフォーマットを持つ `資産リスト.csv` ファイルを持っている。
* **When:** ユーザーがそのCSVファイルをアップロードし、「インポート実行」ボタンをクリックする。
* **Then:**
    * サーバーは `POST /api/import/csv` を受け付ける。
    * アプリケーションはCSVの内容を検証し、データベースに **Upsert（差分更新・追加）** する。
    * 画面に「インポートが完了しました。XX件の資産が処理されました。」という成功メッセージが表示される。
    * 監査ログ (`audit_log`) に、処理件数が記録される。

#### **シナリオ: サーバー上のCSVファイルの変更が自動でアプリに反映される (ファイルウォッチ)**

* **Given:** アプリが稼働中であり、監視対象の `data/portfolio.csv` ファイルがサーバー上に正本として存在する。
* **When:** 管理者がサーバー上の `data/portfolio.csv` を（SFTPなどで）直接編集し、保存する。
* **Then:**
    * ファイルウォッチャー（`inotify`）が変更を検知し、同期処理を開始する。
    * データベースへの差分がUpsertされ、アプリのダッシュボードに変更が即時反映される。

#### **シナリオ: フォーマットが不正なCSVファイルをインポートしようとする**

* **Given:** `admin`ユーザーがインポートしようとしているCSVファイルのデータに、必須項目が欠けているなどの規約違反がある。
* **When:** インポート処理（手動または自動）が実行される。
* **Then:**
    * データベースへの変更は一切行われず、トランザクションが安全に**ロールバック**される。
    * 手動インポートの場合は画面に、自動同期の場合はサーバーログに、原因がわかるエラーメッセージが出力される。

***

### **5. データ分析ダッシュボード**

**フィーチャー:** 記録した資産データを様々なグラフで視覚的に分析し、ポートフォリオの状態を深く理解できるようにする。

#### **シナリオ: 高額資産トップ3の表示ルールを遵守する**

* **Given:**
    * 資産A: `name="純金小判"`, `note="50g"`
    * 資産B: `name="Kudoke 2 Indigo"`, `note=""` (空文字)
* **When:** ユーザーがダッシュボードを表示する。
* **Then:**
    * 「高額資産 Top 3」セクションに、これらの資産が表示される。
    * 資産Aは `純金小判 (50g)` の形式で表示される。
    * 資産Bは `Kudoke 2 Indigo` のみ表示され、**空の括弧 `()` や `(undefined)` などが表示されることは決してない**。

#### **シナリオ: アセットクラス別の構成比率を分析する**

* **Given:** 「日本株」「米国株」「時計」「不動産」クラスの資産が複数登録されている。
* **When:** ユーザーがダッシュボードを表示する。
* **Then:**
    * 「アセットクラス別配分」という円グラフが表示される。
    * 各アセットクラスの時価評価額の合計が計算され、ポートフォリオ全体に占める割合がパーセンテージで正しく表示される。

***

### **6. サーバー運用 (Ubuntu Server 24.04)**

**フィーチャー:** アプリをサーバー上で常時稼働させ、LAN内のどのデバイスからでも簡単な名前でアクセスできるようにする。

#### **シナリオ: サーバーの起動とポート検証**

* **Given:** サーバーでアプリを起動しようとしている。
* **When:** `PORT=3008 node server.js` のように、**`3009` 以外のポート**を指定して起動を試みる。
* **Then:** アプリは起動せず、エラーメッセージを出力して終了する。
* **When:** `node server.js` で正しく起動する。
* **Then:** アプリはポート **`3009`** で待ち受け状態になる。

#### **シナリオ: systemdによるサービス化**

* **Given:** `/etc/systemd/system/assets.service` が正しく設定されている。
* **When:** `sudo systemctl start assets` を実行する。
* **Then:** アプリがバックグラウンドで起動し、サーバーを再起動しても自動で立ち上がる。

#### **シナリオ: ローカルネットワークからのアクセス**

* **Given:** サーバーでmDNS(Avahi)とNginx(リバースプロキシ)が正しく設定されている。
* **When:** LAN内の別のPCやスマートフォンのブラウザで `http://assets.local` を開く。
* **Then:** ポート番号なしで、資産ポートフォリオアプリの閲覧専用ダッシュボードが表示される。