現在管理ページ内の「重複統合」機能についての改修案
１、重複統合ページと機能そのものはいらないことで、慎重に削除する。
２、株（アメリカ株、日本株共通）に関しての新規登録方法へ機能追加すべき。
BDD
管理画面の資産一覧ページ
「新規登録」
↓
「クラス別フィールド」
↓
「口座種類」→特定口座
　　　　　　→一般口座
　　　　　　→NISA
三種類の選択しを出すこと

DB上へ追加するたびに：
when:us_stock_は同じティッカー、且つ、口座種類が同種類
then:以前に登録した同資産へ株数を加算でし、平均取得単価＝｛（旧DB資産の平均取得単価（USD）×旧DB資産株数）+（追加資産平均取得単価（USD）×追加株数）｝÷合算後の総株数　へ更新
when:jp_stockは同じ銘柄コード、且つ、口座種類が同種類
then:以前に登録した同資産へ株数を加算でし、平均取得単価＝｛（旧DB資産の平均取得単価（円）×旧DB資産株数）+（追加資産平均取得単価（円）×追加株数）｝÷合算後の総株数　へ更新

具体案
- 口座粒度の明確化: 「特定/一般/NISA」追加。
- 統合キーの拡張: 統合条件を「クラス＋識別子（US: ticker, JP: code）＋（口座種＋金融機関/口座番号）」に。異なる証券会社の同口座種を誤統合しないため。
- 取得単価の厳密化: 平均取得単価は「加重平均」に固定。ただし将来の損益計算に備え「ロット（買付単位）」もテーブルで保持可能にしておく（UIは集約表示、内部はlot明細）。
- 通貨・為替の取り扱い: US株では「avg_price_usd（USD）」と「簿価JPY」を分離管理。US株の簿価JPYは取引時為替で算出・保存（外部APIを使わない方針なのでフォーム入力またはローカルレート表を選択）。
- 売却・分割等の将来拡張（推奨）: 売却（株数減）や株式分割/併合、ティッカー変更/上場市場変更、ADR/現地株の紐づけに備え、イベント履歴テーブルを用意（後方互換の器だけ作る）。

**提案（DB/モデル）**
- 新規テーブル: `accounts(id, broker, account_type, nisa_kind, name)` を追加。`account_type`: 特定/一般/NISA、`nisa_kind`: growth/tsumi/old など。
- 既存テーブル拡張: 
  - `us_stocks(asset_id PK, ticker, exchange, quantity, avg_price_usd, market_price_usd, account_id FK)`
  - `jp_stocks(asset_id PK, code, quantity, avg_price_jpy, account_id FK)`
- ユニーク制約: `UNIQUE(ticker, account_id)`（US）、`UNIQUE(code, account_id)`（JP）で論理的重複を防止。
- 将来のロット管理（任意）: `lots(asset_id, trade_date, quantity, unit_price_native, currency, fx_at_acq)` を用意（当面は集約に同期）。

**提案（統合アルゴリズム）**
- 判定: 追加対象が `class in (us_stock, jp_stock)` かつ同一識別子＋同一`account_
id`の既存があれば統合、なければ新規。
- 数量加算: `new_qty = old_qty + add_qty`
- 平均取得単価:
  - US: `new_avg_usd = (old_avg_usd*old_qty + add_avg_usd*add_qty) / new_qty`
  - JP: `new_avg_jpy = (old_avg_jpy*old_qty + add_avg_jpy*add_qty) / new_qty`
- 簿価JPY更新:
  - US: `new_book_jpy = floor2( (old_avg_usd*old_qty +add_avg_usd*add_qty) * fx_ref )` ではなく、簿価は「ロット簿価合計」で管理するのが堅い。ロット未導入なら暫定で `unit_book = old_book/old_qty` の比例計算を踏襲しつつ、将来lot化に備えて`bookval`サービスに計算戦略を追加。
- 監査ログ: 統合の差分（旧→新）、入力パラメータ、ユーザーID、計算式のコンテキスト（fx含む）を`audit_log`に記録。

**提案（UI/UX）**
- 新規登録フォーム:
  - アセットクラス選択 → クラス別フィールド表示（US: ticker, avg_price_usd, quantity, fx; JP: code, avg_price_jpy, quantity）
  - 口座選択（account picker）。「新規口座作成」モーダルも許可。
  - 送信前プレビュー: 統合対象が見つかった場合に「統合プレビュー（株数/平均取得単価/簿価の変化）」を表示し確認。
- 例外対応: 通貨/口座不整合、ティッカー/コード未検出、0以下数量などは行単位でエラー化。

**提案（API/実装）**
- エンドポイント拡張: `POST /admin/assets` に `merge_policy: 'auto_weighted_avg'` と `account_id` を追加。内部でUPSERT的に処理。
- トランザクション: 統合は1トランザクションで、assets/us_stocks|jp_stocks/valuations/auditを一括更新。
- 一意制約活用: `INSERT ... ON CONFLICT(ticker, account_id) DO UPDATE SET ...`でレース時も正しく集約（ロジックはアプリ側で計算）。
- 既存 `DuplicateDetectionService`: 重複統合サービス削除。貴金属などの曖昧重複に関しては別途実装。

**提案（移行/整合性）**
- マイグレーション:
  - `accounts` 作成 → `us_stocks/jp_stocks` に `account_id` 追加（ 初期値は「デフォルト口座」へ付与）
  - ユニーク制約追加前に既存重複をレポートし、ワンショット統合スク リプトで加重平均統合
- 検証: 代表ケースのスナップショットで before/after の株数・平均単 価・簿価一致を自動照合。

**提案（テスト）**
- 単体: 重複なし/あり、端数株、0株→追加、極端価格差、複数回統合、US/JP別。
- API: 監査ログの内容検査。
- リグレッション: 既存の評価額算出（market value）に影響しないこと 。

**オープン事項（要確認）**
- 口座の粒度: 証券会社単位まで区別する
- 新NISAの枠管理: つみたて/成長枠の区別や年次移行の扱い。（しない）
- US株の簿価JPY: 取引時レートの入力運用。
- 「重複統合」UIの完全廃止可否: 別途新規実装のため、現UI廃止。