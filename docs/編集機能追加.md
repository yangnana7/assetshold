# 既存資産「編集機能」追加 立案書（新フォーマット準拠化）

本提案は、現有DBの資産レコードを新フォーマット（口座ID・識別子正規化・加重平均ロジック）へ安全に編集・整備できる機能を追加するための仕様案です。実装は本レビュー後に着手します（CSV導入は採用しません）。

## 1. 目的と非目的
- 目的: 既存の資産を「新フォーマット」に整合させる編集UXとAPIを提供する。
  - 口座ID（`account_id`）の設定/変更
  - 識別子（US:ticker / JP:code）の正規化
  - 数量・平均取得単価の修正と簿価JPYの再計算（unit/scale）
  - 編集時の自動統合（同一キー発生時）
- 非目的:
  - 一括CSV更新や外部取込の導入（対象外）
  - 売却・分割など履歴管理の実装（将来検討）

## 2. 対象スコープ
- 対象クラス: `us_stock`, `jp_stock`
- 対象項目（共通）: `name`, `note`, `acquired_at`, `liquidity_tier`, `tags`, `valuation_source`, `book_value_jpy`（推奨は再計算）
- クラス別:
  - US: `ticker`, `exchange`, `quantity`, `avg_price_usd`, `account_id`
  - JP: `code`, `quantity`, `avg_price_jpy`, `account_id`

## 3. 主要要件
- 口座編集:
  - 既存資産に`account_id`が未設定の場合は必須入力。
  - 口座変更時、同一（クラス+識別子+新`account_id`）の既存ポジションがある場合は「編集に伴う統合」を選択可能（プレビュー必須）。
- 識別子編集:
  - USは`ticker`を大文字・トリムで正規化。JPは`code`のトリム（必要に応じて桁・形式チェック）。
  - 正規化後の一意性は、US: `UPPER(TRIM(ticker)), account_id`、JP: `UPPER(TRIM(code)), account_id`。
- 数量・平均単価・簿価:
  - 再計算モードを選択: `auto` / `unit` / `scale`。
  - `unit`: ロット簿価合計（USは取得時為替の入力が望ましい）。
  - `scale`: 旧簿価の単価比例スケール（暫定）
- 監査ログ:
  - 編集前後差分、再計算方式、入力コンテキスト（`account_id`、fx 等）を記録。
- エラーハンドリング:
  - docs/「重複統合」機能の改修案 の「管理画面エラーメッセージ一覧」に準拠。

## 4. UXフロー（画面）
- 詳細画面 → [編集] ボタン → 編集フォーム/モーダル
- 入力欄（例）
  - 共通: 名称、取得日、メモ、流動性、タグ
  - 口座: [口座選択 ▼] [口座を新規作成]
  - US: ティッカー、取引所、数量、平均取得(USD)、取得時為替(USDJPY, 任意)
  - JP: 銘柄コード、数量、平均取得(JPY)
  - 再計算モード: (auto | unit | scale)
- ボタン
  - [プレビューを表示] → 差分・方式（unit/scale）・簿価推移を表示
  - [この内容で保存する]（統合が発生する場合は「この内容で統合する」）
  - [キャンセル]
- 統合発生プレビュー例
  - 対象: us_stock / AAPL / 口座ID:2
  - 統合方式: unit（取得時為替を使用）
  - 数量: 10 → 15、平均単価(USD): 100.00 → 106.6667、簿価(円): 150,000 → 243,000

## 5. API案（実装前提仕様）
- PATCH `/api/assets/:id`
  - ボディ（例）
    - 共通: `class`, `name?`, `note?`, `acquired_at?`, `liquidity_tier?`, `tags?`
    - 口座: `account_id?` または `account?`（新規作成: `broker`, `account_type`, `name?`）
    - US: `ticker?`, `exchange?`, `quantity?`, `avg_price_usd?`, `fx_at_acq?`
    - JP: `code?`, `quantity?`, `avg_price_jpy?`
    - 再計算: `recalc`（`auto`|`unit`|`scale`）
    - プレビュー: `dry_run: true`
  - 挙動
    1) 変更キー（クラス+識別子+`account_id`）の衝突チェック
    2) 衝突あり: 統合プレビュー（数量・平均・簿価・方式）を返却（`dry_run`）→ ユーザー確定時にトランザクション適用
    3) 衝突なし: 通常の編集プレビュー/保存
  - レスポンス（例）
    - `merged: true/false, before: {...}, after: {...}, method: 'unit'|'scale', audit_id?`
- 口座新規作成
  - POST `/api/accounts`（既存）を利用。編集フォームからモーダルで作成 → 選択反映。

## 6. バリデーション
- 必須: `class`, （必要に応じて）`account_id`、識別子（US:ticker / JP:code）
- 数量/平均取得: 正の数
  - USは小数株を許容（現状の更新処理が整数制約になっているため要改善提案）
  - JPは整数推奨
- 取得時為替（US任意）: 入力時は正の数
- 一意制約: 編集後のキー重複は禁止（統合で解決する場合のみ許可）

## 7. 再計算仕様（編集時）
- US（unit 推奨）
  - `new_qty = old_qty + delta_qty`
  - `new_avg_usd = (old_avg_usd*old_qty + add_avg_usd*add_qty) / new_qty`
  - `new_book_jpy = old_book_jpy + floor2(add_qty * add_avg_usd * fx_at_acq)`（fx不明ならscale）
- JP（unit 固定）
  - `new_avg_jpy = (old_avg_jpy*old_qty + add_avg_jpy*add_qty) / new_qty`
  - `new_book_jpy = old_book_jpy + add_avg_jpy * add_qty`
- scale（共通）
  - `unit_book = old_book_jpy / old_qty`、`new_book_jpy = floor2(unit_book * new_qty)`

## 8. 監査ログ
- action例: `ASSET_EDIT`, `ASSET_EDIT_MERGE`
- 記録内容: before/after、方式（unit/scale）、`account_id`変化、識別子変化、呼出元（UI/API）、ユーザーID

## 9. 既存DB整備（注意事項）
- 編集開始前に、次を満たすようガイドを表示:
  - 全`us_stocks`/`jp_stocks`に`account_id`が設定
  - USは`ticker`大文字+トリム、JPは`code`トリム（必要なら桁検証）
  - 一意性を侵さないよう、重複候補は「編集に伴う統合」で解消
  - 監査ログが必ず残るよう、UI/API経由での編集を推奨

## 10. エッジケースと対処
- 識別子/口座変更により重複キー発生: 統合プレビューを強制表示。確定でマージ or キャンセル。
- 取得時為替なし（US）: `scale`での再計算を自動選択（ユーザーへ明示）。
- 小数株（US）: UIとAPIで許容。既存の整数制約がある場合は編集処理で許容する方向へ改善（提案）。
- アセットクラス変更: 非対応（別要件）。

## 11. UI文言（運用向け）
- ボタン: 「プレビューを表示」「この内容で保存する」「この内容で統合する」「口座を新規作成」「保存する」「キャンセル」
- メッセージ例:
  - 「この編集により同一口座・同一銘柄の既存ポジションが見つかりました。統合プレビューをご確認ください。」
  - 「取得時為替が未入力のため、簿価は比例スケールで再計算されます。」

## 12. セキュリティ/権限
- `PATCH /api/assets/:id` は `requireAuth`（または管理者限定にする場合は`requireAdmin`）
- 口座作成は `requireAdmin`
- 監査ログは実ユーザーIDで記録（開発時のみフォールバック）

## 13. 受け入れ条件（抜粋）
- 既存資産に`account_id`を設定・変更できる
- 識別子の正規化が行える（US:大文字化、JP:トリム）
- 数量・平均取得単価変更時にプレビューで前後差分・再計算方式を確認できる
- 編集により重複が発生する場合、統合プレビューを経て確定できる
- 監査ログに編集前後、方式、ユーザー、口座情報が記録される

## 14. ロールアウト
- ステップ:
  1) 画面・APIの追加（プレビューと保存の2段階）
  2) 一意制約違反エラーメッセージの日本語化と統合プレビュー誘導
  3) 代表データでの手動検証 → 本番反映
- 影響: 既存の閲覧/登録には影響なし。編集のみの追加。

## 15. テスト観点
- 正常: 口座未設定→設定、数量+単価編集、識別子変更、US/JPの再計算、統合あり/なし
- 境界: 0/負値/NaN拒否、小数株（US）、一意制約直前/直後
- 監査: エラー時/成功時のログ内容
- 権限: 未ログイン/一般/admin の各動作

以上。レビュー後、API I/Fと画面仕様を確定して実装に着手します。

## 16. 画面ワイヤ（簡易）

### 16.1 編集フォーム（共通）
```
[資産を編集]
クラス: (us_stock | jp_stock) ▼   口座: [Account Picker ▼] [口座を新規作成]
名称: [........................................]
取得日: [YYYY-MM-DD]    メモ: [.................................]
流動性: [L1/L2/L3/L4 ▼]  タグ: [.........................]

-- us_stock 選択時 --
ティッカー: [AAPL]      取引所: [NASDAQ ▼]
数量:       [  5.0 ]    平均取得単価(USD): [120.00]
取得時為替(USD/JPY 任意): [155.00]
再計算モード: (auto | unit | scale)

-- jp_stock 選択時 --
銘柄コード: [7203]
数量:       [  50 ]     平均取得単価(JPY): [2200.00]
再計算モード: (auto | unit | scale)

[プレビューを表示]   [この内容で保存する]   [キャンセル]
```

- 入力規則（抜粋）:
  - 口座は必須。USの数量は小数可、JPは整数推奨。
  - USの平均取得単価はUSD、JPはJPY。取得時為替入力時はunit法を優先。

### 16.2 統合プレビュー（発生時）
```
[統合プレビュー]
対象: us_stock / AAPL / 口座ID:2
統合方式: unit（取得時為替 155.00 を使用）

数量      :   10  →  15
平均単価  : USD 100.00  →  USD 106.6667
簿価(円)  : 150,000     →  243,000

[キャンセル]   [この内容で統合する]
```

### 16.3 口座新規作成（モーダル）
```
[口座を新規作成]
証券会社: [SBI証券 ▼]
口座種別: (特定 | 一般 | NISA)
表示名  : [SBI/特定]

[保存する]
```

### 16.4 エラーステート例（インライン）
```
数量: [  -3 ]  ← エラー: 「数量は正の数で入力してください」
平均取得単価(USD): [ 0 ] ← エラー: 「平均取得単価(USD)は正の数で入力してください」
```

フォーカスは最初のエラーへ自動スクロール。トーストに概要も表示。

## 17. API ボディ/レスポンス例

以下は仕様確認用の例です（実装は未着手）。`withCredentials: true` 前提。

### 17.1 US: 統合プレビュー（dry_run=true, unit法）
リクエスト
```http
PATCH /api/assets/42
Content-Type: application/json

{
  "class": "us_stock",
  "account_id": 2,
  "ticker": "AAPL",
  "exchange": "NASDAQ",
  "quantity": 5,
  "avg_price_usd": 120.0,
  "fx_at_acq": 155.0,
  "recalc": "auto",
  "dry_run": true
}
```
レスポンス
```json
{
  "merged": true,
  "before": { "qty": 10, "avg_usd": 100.0, "book_jpy": 150000 },
  "after":  { "qty": 15, "avg_usd": 106.6667, "book_jpy": 243000 },
  "method": "unit"
}
```

### 17.2 JP: 通常編集プレビュー（dry_run=true, 統合なし）
リクエスト
```http
PATCH /api/assets/51
Content-Type: application/json

{
  "class": "jp_stock",
  "account_id": 1,
  "code": "7203",
  "quantity": 50,
  "avg_price_jpy": 2200.0,
  "recalc": "unit",
  "dry_run": true
}
```
レスポンス
```json
{
  "merged": false,
  "preview": {
    "class": "jp_stock",
    "code": "7203",
    "account_id": 1,
    "quantity": 50,
    "avg_price": 2200.0,
    "recalc": "unit"
  }
}
```

### 17.3 確定保存（統合あり）
リクエスト
```http
PATCH /api/assets/42
Content-Type: application/json

{
  "class": "us_stock",
  "account_id": 2,
  "ticker": "AAPL",
  "quantity": 5,
  "avg_price_usd": 120.0,
  "fx_at_acq": 155.0,
  "recalc": "auto",
  "dry_run": false
}
```
レスポンス
```json
{
  "merged": true,
  "kept_asset_id": 42,
  "before": { "qty": 10, "avg_usd": 100.0, "book_jpy": 150000 },
  "after":  { "qty": 15, "avg_usd": 106.6667, "book_jpy": 243000 },
  "method": "unit",
  "audit_id": 9901
}
```

### 17.4 口座新規作成を同時に行う（仕様案）
リクエスト（`account`キーで新規作成 → `account_id`に反映）
```http
PATCH /api/assets/60
Content-Type: application/json

{
  "class": "jp_stock",
  "account": { "broker": "SBI", "account_type": "tokutei", "name": "SBI/特定" },
  "code": "8306",
  "quantity": 100,
  "avg_price_jpy": 800.0,
  "recalc": "unit",
  "dry_run": true
}
```
レスポンス
```json
{
  "merged": false,
  "preview": { "class": "jp_stock", "code": "8306", "account_id": 7, "quantity": 100, "avg_price": 800.0, "recalc": "unit" }
}
```

### 17.5 エラー例（日本語文言に対応）
数量エラー
```json
{ "error": "quantity_invalid" }
```
必須未入力
```json
{ "error": "account_required" }
```
一意制約違反（統合誘導）
```json
{ "error": "merge_conflict" }
```
