**ティッカー照合の切り分け専用キット**を作りました。ORCL（NYSE）のようなケースで、どのキーを使ってどのURLからいくらを拾ったかを、その場で確認できます。

### これでできること

* `resolveKeys` が導いた**各サイト用キー**（Google/Yahoo/MarketWatch）を確認
* **Yahooのドメインを明示**（`.com` / `.co.jp`）して取得 → `.com` は USD、`.co.jp` は多くの場合 JPY
* 取得した **URL / 価格 / 通貨** をそのままJSONで返却
* 集約は **USDのみ**で中央値。JPYは自動で外れる（`removed`）

### 使い方（サーバに診断APIを追加）

1. このzipの `src/` と `symbol_registry.json` を既存プロジェクトへ配置（上書きOK）
2. ルータに追加（Express）

   * `src/routes/market.probe.ts` の `probeHandler` を `/api/market/probe` に結線
3. 実行例（ORCL, NYSE）

```
GET /api/market/probe?ticker=ORCL&exchange=NYSE&providers=yahoo,google,marketwatch&yahoo_host=com
```

→ 期待：`google` は `ORCL:NYSE` / `yahoo` は `finance.yahoo.com/quote/ORCL`（USD）が使われ、両者が±1%以内なら `confidence:"agree"`。

> **ポイント（今回の症状に直結）**
> 例リンクは Google が `ORCL:NYSE`（OK）、Yahoo が **`finance.yahoo.co.jp`** でした。日本版は HTML 構造が違い、**通貨もJPYになりがち**です。
> 本キットでは `yahoo_host` を**明示**できます。**USDが欲しいときは `com` を指定**してください。

### よくある誤りと対策

* **誤**：`resolveKeys` は正しいのに、実際のフェッチが `co.jp` を見に行っている
  → `/api/market/probe?...&yahoo_host=com` で確認し、`/api/valuations/:id/refresh` 側も `yahooHost: "com"` を固定
* **誤**：MarketWatchキーが `ORCL` でなく `orcl`/`orcl:us` の揺れ
  → すでに `resolve.ts` で小文字・ダッシュへ正規化済み
* **乖離**：GoogleとYahooの差が1%超
  → レスポンス `confidence:"conflict"` とともに各URL/値が返るので、どちらを採用するかUIで選択

### 既存の `/api/valuations/:assetId/refresh` でも使えます

`src/routes/valuations.refresh.ts` を同梱しています。リクエストボディに `yahooHost: "com"` を渡せます（既定は `"com"`）。

---

スクショの銘柄（オラクル）で検証したい場合、まずは上の `probe` を `.com` と `.co.jp` でそれぞれ叩いて結果（`fetches[]`）を見てみてください。
そこで **URL・通貨・価格** が意図どおりか確認できれば、残るのは UI 側の「表示通貨/丸め/前日比」などの話に絞れます。
