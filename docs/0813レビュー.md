# 結論（要点だけ先出し）

* **致命的ブロッカー**が複数：

  1. `valuations` テーブルに **`unit_price_jpy` カラムが無い**のに、保存/参照で **使っている**（SQLエラー確定）。
  2. フロントの複数ファイルに **`...` がコードとして混入**（例: `Tooltip...sponsiveContainer`）。**ビルド不能**。
  3. 既定管理者 **`admin/admin` 自動作成**、`session.secret` **固定文字列**、**CSRF無し**。
  4. CSV仕様が **簡略化版**のまま（BDDの正本ヘッダ未対応、日付・通貨の**異常値混入**に脆い）。
  5. **FX/貴金属プロバイダがモック**（FXはYahooクラスだが**実レート未取得**、田中は**静的**）。

* **だが基礎は良い**：
  固定ポート強制（3009）・`MARKET_ENABLE` ゲート・`price_cache` と TTL・`/api/market/status`・`valuations/refresh(-all)`・CSV監視・監査ログ（who/what/old→new/source）など、**追記BDDの土台はほぼ実装済み**。

* **最短ルート**：
  まずブロッカーを**4本のPR**に分割して連続投入 → UI刷新（多層カード&ダッシュボード） → セキュリティ/運用の底上げ → BDD完全準拠のCSV/評価系を仕上げ、です。

---

# ① まず潰すべきブロッカー（即修正パッチ）

## A. `valuations` スキーマ不整合（**最優先**）

**現状**

* 定義：`valuations(id, asset_id, as_of, value_jpy, fx_context)`
* 参照/保存：`SELECT unit_price_jpy, value_jpy ...`、`INSERT (..., unit_price_jpy, ...)` → **必ず落ちる**。

**対応**（SQLiteなので後付け可能）

```sql
-- migrations/20250813_add_unit_price_to_valuations.sql
ALTER TABLE valuations ADD COLUMN unit_price_jpy REAL;
CREATE INDEX IF NOT EXISTS idx_valuations_asset_asof ON valuations(asset_id, as_of);
```

サーバ起動時に `PRAGMA user_version` で移行を自動適用するか、起動前に一度流してください。
合わせて、`GET /api/assets/:id` の直近評価取得は `ORDER BY as_of DESC, id DESC LIMIT 1` に寄せると堅い。

## B. フロントの **`...` 混入**（**ビルド不能**）

**例**

* `client/src/pages/Dashboard.jsx` の import：`Tooltip...sponsiveContainer`
* `index.css` に `...` と中断行（`color: #55`で終端）
* `UserManagement.jsx / Import.jsx / Header.jsx` 等にも点在

**対応**

* まず機械除去で全体を正常化：
  `grep -R --line-number '\.\.\.' client | cut -d: -f1 | sort -u` で該当を洗い出し、**意図しない `...` を全削除**。
* Recharts の正しい import に修正：

  ```js
  import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts'
  ```
* CSS は **シンタックス途中終了**があるため、まずビルドが通る最小形に復元（後述の「多層カード」最終デザインへ一気に差し替え推奨）。

## C. 認証まわりの**危険既定値**

* `admin/admin` を自動投入、`session.secret` 固定 `'portfolio-secret-key'`。
* **対策**

  * 初回起動時に `ADMIN_SETUP_REQUIRED` フラグを立て、**ログイン画面で強制初期パスワード設定**（完了後にフラグ解除）。
  * `SESSION_SECRET` を `.env` 必須へ。`cookie: { sameSite: 'lax', secure: NODE_ENV==='production', httpOnly: true }`。
  * `/api/login` に **レートリミット**（例: 5回/分/IP）、失敗も監査ログ。
  * 可能なら **CSRF**（同一オリジン運用でも将来の拡張を見越して `csurf` or トークン埋め込み）。

## D. CSV 正本仕様 & バリデーション

* 今のインポートは `class,name,book_value_jpy,liquidity_tier` 最小のみ。
* `data/portfolio.csv` 自体が **異常日付**（`15-2024-12` 等）や**通貨記号混在**（¥/\$）を含む。

**対応**

* BDDの**正本ヘッダ**へ拡張（us/jp株・貴金属・不動産・現金・コレクションの横断カラム群）。
* **正規化関数**を導入：

  * `book_value_jpy`: 記号除去→数値、**0以下は拒否**（既に実装済みだが強化）。
  * `acquired_at`: 受理形式を `YYYY-MM-DD` のみに統一（他形式は**即エラー**）。
  * `liquidity_tier`: `L1..L4` の **列挙チェック**。
  * `class` は **許容クラス列挙**（`us_stock,jp_stock,precious_metal,watch,collection,real_estate,cash`）。
* 1行でも失敗で**トランザクション全体ロールバック**（現状その方針はOK）。
* 成功/失敗件数と**1行ごとのエラー**を返す（UIで表示）。

---

# ② BDD／追記BDDとの整合（何ができていて、何が足りないか）

**できている**

* 固定ポート 3009 の **MUST FAIL** 実装
* `MARKET_ENABLE` ゲート（未有効時 403）
* `price_cache`＋TTL＋**fetchロック**
* `POST /api/valuations/:id/refresh`（ゲスト可）／`/refresh-all`／`GET /api/market/status`
* 監査ログ：`source='api|csv_import|csv_watcher'`、event名も粒度あり

**不足/弱い**

* **FXプロバイダ**がモック（実レート未取得）。
* **田中貴金属**が静的（スクレイピング未実装）。
* `valuations` の **月次推移** API/集計を UI が未表示（折れ線二本：簿価vs評価）。
* CSV 正本ヘッダ未対応（上記）。
* UI の **多層カード**仕様（CSS指示書）が未適用。
* CORS 固定（`http://localhost:5173`）で、**本番 assets.local 同一オリジン**時の想定が曖昧。

---

# ③ UI/UX：見やすさ・わかりやすさの**決定版**

**多層カード（CSS仕様書どおり）**

* **Grid 2fr:1fr**、左＝属性（ブランド/型番・金属/重量・地積/権利…）、右＝**財務**（評価額を最大・右寄せ、下に簿価、最後に損益±色分け）。
* **かっこ表示規約**：`note` が空なら**括弧を出さない**（既に `formatAssetName` 実装済だが一覧/カードでも徹底）。
* **ステータスバッジ**：`valuation_source`・`market: enabled/disabled`・`最終更新(JST)`・`stale` を明示。
* **一覧**は TanStack Table（固定ヘッダ・列フィルタ・合計行・仮想スクロール）に変更。
* **ダッシュボード刷新**

  * ドーナツ（資産配分）、**二本線の月次推移**（簿価 vs 最新評価）、Top3カード。
  * 右上に **Market Status** バッジ（Provider名と時刻、staleなら黄）。
* **新規登録はウィザード化**（クラス別に必要フィールドだけ順次表示／`note`は空でも可を明示）。

> 補足：現行の `srccomponents/` などの**誤フォルダ**は削除。`src/` のみに整理。

---

# ④ 市場データ：実用に上げる最短手

* **FX（USDJPY/CNYJPY）**：`YahooFxProvider` を**実取得化**（現状モック）。YahooのチャートAPIと `quoteSummary` のどちらかで10秒タイムアウト・UA偽装は既に雛形あり。
* **JP/US株**：`YahooStockProvider` は通信実装済み（内部も一部 `...` 断片あり、要整復）。
* **貴金属（田中）**：まず**日次スポット**をスクレイピング実装。将来的に「地金」vs「製品（小判・工芸品）」の差を UI で明示（**アートプレミアム**欄を追加）。

計算規約（追記BDDの要旨をコード化）

* US株：`price_usd * quantity * USDJPY` → **小数点以下切り捨て2桁**、最終的に整数JPYへ。
* JP株：`price_jpy * quantity`。
* 貴金属：**純度×グラム単価×重量**（`unit_price_jpy` は購入参考、田中スポットとの**差額を “Premium”** として表示）。

---

# ⑤ セキュリティ & 運用の底上げ

* **session**：`.env` から `SESSION_SECRET`、cookie `sameSite:'lax'` `secure:true(本番)` `httpOnly:true`。
* **helmet** を導入、`x-powered-by` 無効化。
* **/api/login** に rate-limit（例: 5/min/IP）＋ロックアウト短時間（観測ログは `audit_log`）。
* **CORS**：開発時のみ `origin: http://localhost:5173`、本番は**同一オリジン**で CORS 無効化（=不要）。
* **systemd**：`Environment=SESSION_SECRET=...`、`MARKET_ENABLE=0` を既定、必要時のみ `1`。
* **バックアップ**：既に WAL + checkpoint + コピーあり。**世代管理**（N世代残し）& 失敗通知ログを足すと安心。

---

# ⑥ テスト（最小でもここまで）

**API（Jest+Supertest）**

* `PORT=3008 node server.js` → **起動失敗**（3009固定）。
* 未ログイン `POST /api/assets` → **401**。
* `MARKET_ENABLE=0` で `POST /api/valuations/:id/refresh` → **403 {code:'market\_disabled'}**。
* 壊れたCSV → **トランザクション全ロールバック**。
* `valuations` への `unit_price_jpy` あり/なしでの **マイグレーション前後**挙動。

**E2E（Playwright）**

* 未ログインは **ダッシュボードのみ**。
* adminログイン後：一覧/作成/編集/削除が出現、Top3の**空括弧非表示**、市場バッジ表示、\*\*“全更新”\*\*クリックで件数アラート。

---

# ⑦ 提案するPR分割（最短で戦える順）

1. **DBマイグレーション & バグ修正**

   * `valuations.unit_price_jpy` 追加、関連SQL修正、直近評価の `ORDER BY as_of DESC` 統一。
2. **セキュリティ初期化**

   * `SESSION_SECRET` 必須化、`admin/admin` 廃止（初期セットアップフロー）、rate-limit、helmet。
3. **CSV正本 & 正規化**

   * ヘッダ拡張・厳格バリデーション・詳細なエラー返却、Exportの `?format=csv|md|json` ひな形。
4. **UI修繕 & ダッシュボード**

   * `...` 除去、Recharts import修復、**多層カード**と**月次二本線**、Marketバッジ、TanStack Table導入。
5. **市場データの実用化**

   * FXを実取得化、田中スクレイピング簡易版、`stale` 表示とTTLテスト。

---

# ⑧ 具体的パッチ（抜粋）

**server.js（セッション/セキュリティ）**

```diff
- app.use(session({
-   secret: 'portfolio-secret-key',
-   resave: false,
-   saveUninitialized: false,
-   cookie: { secure: false, httpOnly: true, maxAge: 24 * 60 * 60 * 1000 }
- }));
+ const helmet = require('helmet');
+ app.use(helmet());
+ const SESSION_SECRET = process.env.SESSION_SECRET;
+ if (!SESSION_SECRET) { console.error('SESSION_SECRET is required'); process.exit(1); }
+ app.use(session({
+   secret: SESSION_SECRET,
+   resave: false,
+   saveUninitialized: false,
+   cookie: {
+     httpOnly: true,
+     sameSite: 'lax',
+     secure: process.env.NODE_ENV === 'production',
+     maxAge: 24 * 60 * 60 * 1000
+   }
+ }));
```

**migrations**（先述の SQL 2行）を追加し、起動時に適用。

**Dashboard.jsx（Recharts import 修正）**

```diff
-import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip...sponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts'
+import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts'
```

**CSS** は「多層カード」へ全面差し替え（要件：右カラムは右寄せ／評価額最大／損益色分け）。
**CSV** は `acquired_at` を `YYYY-MM-DD` 以外は拒否、`book_value_jpy` の記号除去→数値化を共通関数化。

---

# ⑨ ウォッチ・コイン・時計（評価の透明性）

* `valuation_source`: `manual|market_yahoo|market_tanaka|auction|dealer` など **列挙で管理**。
* 貴金属（小判/工芸品）：**田中スポットとの差額を “Premium” として別表示**（芸術性の上乗せを見える化）。
* 時計：`brand/ref/condition/box_papers` を `tags(json)` で保持、**価格はオークション/中古相場URL**を `source_url` に格納、カードにバッジで表示。

---
