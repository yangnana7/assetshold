# ローカル資産ポートフォリオアプリ — 統合仕様書

> **目的**: 株式、時計、貴金属、不動産など多様な個人資産を、外部に依存しない**完全ローカル環境**で安全に管理・評価・可視化する。

## 0\. 開発体制・基本情報

  * **ソースコード担当:** ClaudeCode
  * **受け入れテスト担当:** あなた
  * **実行環境:** Windows 11 / Ubuntu Server 24.04 LTS
  * **技術スタック:**
      * Backend: Node.js + Express
      * Database: SQLite (`data/portfolio.db`, WAL + 定期checkpoint)
      * Frontend: React + Vite + TanStack Table / Recharts
      * テスト: Vitest + Supertest（API）, Playwright（E2E）
  * **【注記】運用ホスト名/ポート:**
      * 本アプリのホスト名とポートは `assets.local:3009` とする。
      * **最重要規約（MUST FAIL）:** サーバーのポート番号は **`3009` に完全固定**する。環境変数等で `3009` 以外のポートが指定された場合、サーバーはエラーを出力して**起動に失敗しなければならない**。
      * （旧設計にあった家計簿アプリ `kakeibo.local:3008` との並走運用は、一旦スコープ外とする）

## 1\. 非機能要件

1.  **完全ローカル既定:** 外部API通信は既定で行わない。価格・為替取得は**ユーザーによる明示的な有効化時のみ**。
2.  **固定ポート:** ポートは `3009` に固定（上記参照）。
3.  **データ永続化:** SQLite (`data/portfolio.db`) を使用。1分ごとにWALからcheckpoint処理を行い、堅牢性を担保する。
4.  **監査ログ:** すべての作成/更新/削除操作について、差分（旧→新）と操作者を `audit_log` テーブルに記録する。
5.  **バックアップ:** アプリ停止時に `/backup/portfolio_YYYY-MM-DD_HHMM.db` という形式でDBのコピーを自動作成する（この機能は設定でON/OFF可能）。
6.  **言語/通貨:** UIは日本語、表示通貨はJPYを既定とする。**評価通貨としてJPY/USD/CNYの切り替え**に対応する。
7.  **権限管理:** `viewer`（閲覧のみ）と `admin`（全編集可）の2権限を設ける。未ログインユーザーはダッシュボードのみ閲覧可能。
8.  **データ規約:** `note`（備考）フィールドは、未入力の場合 **空文字列 `""`** として保存する（`null` や `undefined` は使用禁止）。

## 2\. ドメインモデル

### 2.1 共通エンティティ

  * **assets**: `id`, `class`, `name`, `note("")`, `acquired_at`, `book_value_jpy`, `valuation_source('manual'|'market_api'|'formula')`, `liquidity_tier('L1'|'L2'|'L3'|'L4')`, `tags(JSON)`
  * **valuations**: `id`, `asset_id`, `as_of`, `value_jpy`, `fx_context`
  * **attachments**: 証書・鑑定書等のファイル参照

### 2.2 クラス別テーブル（抜粋）

  * **us\_stocks:** `asset_id`, `ticker`, `exchange`, `quantity`, `avg_price_usd`
  * **jp\_stocks:** `asset_id`, `code`, `quantity`, `avg_price_jpy`
  * **watches:** `asset_id`, `brand`, `model`, `ref`, `box_papers(bool)`
  * **precious\_metals:** `asset_id`, `metal`, `weight_g`, `purity`
  * **real\_estates:** `asset_id`, `address`, `land_area_sqm`, `building_area_sqm`, `rights`
  * **collections:** `asset_id`, `category`, `variant`
  * **cashes:** `asset_id`, `currency`, `balance`

> **投資可能資金の定義:** `liquidity_tier`が `L1`（超流動資産）または `L2`（流動資産）のものを投資可能資金として算入する。CNYのカード決済枠は `credit_limits` テーブルで別途管理し、算入するかはオプションで提供する。

## 3\. データ連携（CSVが正本）

  * **取り込み（CSV）:**
      * CSVファイルがデータの**正本 (Canonical Source)** となる。
      * CSVファイルの更新は**ファイルウォッチャー (`inotify`)** で自動検知し、差分をDBへUpsert（更新・追加）する。処理中は `import_lock` で排他制御を行う。
      * 管理画面から手動でのアップロードにも対応する。
  * **書き出し:**
      * `GET /api/export?format=csv|md|json` でDBからデータを書き出す。
      * `csv` と `json` はデータ交換用、`md` (Markdown) は人間が読むためのレポート用途とし、編集は非推奨とする。
  * **CSV仕様:** `UTF-8`, `LF`, ヘッダー行あり。カラムは以下の通り。
    ```
    class,name,note,acquired_at,book_value_jpy,valuation_source,liquidity_tier,tags,ticker,exchange,quantity,avg_price_usd,code,avg_price_jpy,brand,model,ref,metal,weight_g,purity,address,land_area_sqm,building_area_sqm,category,variant,currency,balance
    ```
  * **競合解決:** DBとCSVでデータが競合した場合、既定では**DBのデータを優先**する。`?force=csv` パラメータを付与することで、強制的にCSVのデータで上書きすることも可能。

## 4\. 価格・為替（オフライン優先）

  * 既定は **手動評価**。
  * **オンデマンド更新:** ユーザーが明示的に有効化した場合に限り、以下の外部取得を行う。
      * Stocks: プラグイン形式で対応（Yahoo FinanceなどAPIキー不要のものを優先）
      * FX: `USDJPY`, `CNYJPY` をキャッシュ付きで取得。
  * 取得失敗時は直近のキャッシュ値を採用し、UIに**最終更新時刻**を明示する。

## 5\. 画面仕様

### 5.1 未ログイン（閲覧専用ダッシュボード）

  * 純資産総額（NAV）、アセットクラス別配分（円グラフ）、資産総額の月次推移（折れ線グラフ）、高額資産Top3を表示。
  * 【注記】高額資産の備考表示では、空の括弧 `()` や `(undefined)` の表示を禁止する。
  * 検索、並び替え、CSVエクスポート機能を提供。

### 5.2 ログイン後（admin権限）

  * **資産一覧:** インライン編集、部分更新（PATCH）、バリデーション機能を備えたテーブル。
  * **新規登録ウィザード:** アセットクラスを選択後、必要な項目を入力して登録。
  * **一括処理:** CSVの手動インポートと、CSV/Markdown/JSON形式でのエクスポート。
  * **評価更新:** 手動での評価額入力、およびオンデマンドでの市場価格取得。
  * **リバランス試算:** 目標配分（ポートフォリオ）との乖離を計算し、売買候補と税引後見込み額を提示。
  * **不動産ユーティリティ:** 表面/実質利回りの計算、返済計画シミュレーション、目標利回りに必要な物件価格の逆算など。

## 6\. API仕様（REST）

  * `GET /api/assets`: 資産一覧取得（クラス等でフィルタ可能）。
  * `POST /api/assets`: 新規資産登録。
  * `PATCH /api/assets/:id`: 既存資産の部分更新（`note`のみの更新など）。
  * `DELETE /api/assets/:id`: 資産削除。
  * `POST /api/import/csv`: CSVファイルの手動インポート。
  * `GET /api/export?format=csv|md|json`: 各形式でのデータ書き出し。
  * `POST /api/valuations/:id/refresh`: 市場価格・為替のオンデマンド更新（明示的有効化時のみ）。
  * **認可:** 未ログインユーザーは `GET /api/dashboard` のみ許可。その他のAPI、特に編集系（POST, PATCH, DELETE）へのアクセスは **`401 Unauthorized`** を返す。

## 7\. BDDシナリオ（統合・完全版）

### 7.1 認証とアクセス制御

  * **未ログインでのアクセス:**

      * **Given** ユーザーが未ログイン状態でアプリにアクセスする。
      * **When** ページが読み込まれる。
      * **Then** 閲覧専用ダッシュボードが表示され、右上に「ログイン」ボタンのみが表示される。編集UIは一切表示されない。

  * **APIレベルでのアクセスブロック:**

      * **Given** 未ログインのユーザーがいる。
      * **When** ツール等で `POST /api/assets` を直接呼び出す。
      * **Then** サーバーはステータスコード **`401 Unauthorized`** を返す。

  * **adminログインと自動リダイレクト:**

      * **Given** `admin`ユーザーがログインページにいる。
      * **When** 正しい認証情報でログインする。
      * **Then** メインの資産一覧ページ（またはダッシュボード）へ**自動的にリダイレクト**される。
      * **And** 画面上部に「資産一覧」「一括インポート」等のナビゲーションが表示され、全ての機能が利用可能になる。

### 7.2 登録・編集・削除

  * **備考付き新規登録:**

      * **Given** `admin`ユーザーがログインしている。
      * **When** 必須項目に加え、`note`に `"2025年購入の保証書付き"` と入力して資産を登録する。
      * **Then** 一覧に新しい記録が `note` 付きで表示され、DBにもその値が保存される。

  * **`note`の部分更新:**

      * **Given** `note`が空文字の既存資産がある。
      * **When** その資産の `note` のみを `"外箱に傷あり"` に更新し保存する (`PATCH /api/assets/:id`)。
      * **Then** 他のフィールドは保持されたまま `note` のみ更新され、再読込後も表示が継続する。

  * **安全な削除:**

      * **Given** `admin`ユーザーが資産を削除しようとしている。
      * **When** 削除ボタンを押し、確認ダイアログで「OK」をクリックする。
      * **Then** 該当データはDBから削除されるが、`audit_log` には削除の記録が残る。

### 7.3 CSV同期

  * **手動インポート:**

      * **Given** `admin`が「一括インポート」画面を開いている。
      * **When** 規約に準拠したCSVファイルをアップロードし、インポートを実行する。
      * **Then** 検証後に差分がDBにUpsertされ、画面に処理件数が表示される。`audit_log` にも記録が残る。

  * **ファイルウォッチによる自動同期:**

      * **Given** 監視対象の `data/portfolio.csv` がサーバー上に存在する。
      * **When** このファイルが外部から更新・保存される。
      * **Then** `inotify` が変更を検知し、差分をDBへ自動で適用する。ダッシュボードに変更が即時反映される。

  * **不正なCSVからの保護:**

      * **Given** ヘッダーが欠けているなど、規約に違反したCSVファイルがある。
      * **When** このファイルでインポートまたは自動同期が試みられる。
      * **Then** DBへの変更は一切行われず、トランザクションは安全に**ロールバック**される。画面またはログに原因を示すエラーメッセージが出力される。

### 7.4 ダッシュボードの可視化

  * **高額資産Top3の表示規約:**

      * **Given** 資産A (`name="純金小判"`, `note="50g"`) と資産B (`name="Kudoke 2 Indigo"`, `note=""`) がある。
      * **When** ダッシュボードが表示される。
      * **Then** 資産Aは `純金小判 (50g)` と表示され、資産Bは `Kudoke 2 Indigo` と表示される（**空の括弧 `()` は表示されない**）。

  * **アセットクラス別配分（円グラフ）:**

      * **Given** 複数のアセットクラス（日本株、米国株、時計など）の資産が登録されている。
      * **When** ダッシュボードが表示される。
      * **Then** 各クラスの**時価評価額の合計**に基づいた構成比率が、円グラフで正しく表示される。

  * **【新規追加】資産総額の月次推移（折れ線グラフ）:**

      * **Given** 複数月にわたって、資産の簿価と評価額のデータが記録されている。
      * **When** ダッシュボードが表示される。
      * **Then** X軸を年月、Y軸を金額とする折れ線グラフが表示される。
      * **And** 「簿価総額」と「評価額総額」の2本の線が、各月末時点の合計額を正しくプロットする。

### 7.5 サーバー運用と検証

  * **ポート固定の検証:**
      * **When** `PORT=3008 node server.js` のように、**`3009` 以外のポート**を指定して起動を試みる。
      * **Then** アプリは起動せず、エラーメッセージを出力して終了する。
      * **When** `node server.js` または `PORT=3009 node server.js` で起動する。
      * **Then** アプリはポート **`3009`** で正常に待受状態になる。

-----

## 8\. セキュリティと運用

  * **セキュリティ:**
      * ローカルセッション管理とCSRF対策を実装する。
      * パスワードはArgon2を用いてハッシュ化して保存する。
      * **オフライン既定**を貫き、ユーザーが許可しない限りプロセス外へのデータ送信は一切行わない。
  * **運用（Ubuntu 24.04）:**
      * **systemd:** `assets.service` としてサービス化し、サーバー再起動時にも自動で立ち上がるようにする。
      * **Nginx/Avahi:** `assets.local` という名前でLAN内からアクセスできるよう、リバースプロキシとmDNSを設定する。
      * **バックアップ:** `portfolio.db` を日次で個別にローテーションバックアップする。
      * **監視:** CSVの自動同期に失敗した際は、ローカルにメールまたはログで通知する。

## 9\. 今後の拡張案

  * PWA対応によるスマートフォンでの閲覧性向上
  * 税務申告用レポート（配当・譲渡所得）の自動生成
  * 目標ポートフォリオに基づいた自動リバランス提案（税金考慮）
  * オフラインでのリスク分析（資産間の相関、ボラティリティ計算）
