# ローカル資産ポートフォリオアプリ — BDD設計 v1

> 目的: 既存の家計簿アプリの運用実績を活かし、資産（株・時計・貴金属・不動産・コレクション・現預金・外貨）をローカルで安全に管理・評価・可視化する。

---

## 0. 開発体制・基本情報

- **ソースコード担当:** ClaudeCode
- **目視確認／受け入れ:** あなた
- **実行環境:** Windows 11 / Ubuntu Server 24.04 LTS
- **スタック（提案）:**
  - Backend: Node.js + Express（**ローカルのみ**）
  - DB: SQLite（単一ファイル・ロック／トランザクション堅牢）
  - Frontend: React + Vite + TanStack Table/Recharts
  - テスト: Vitest + Supertest（API）, Playwright（E2E）
- **ポート規約:** **家計簿=3008 / 資産=3009（どちらも MUST FAIL 規約適用）**
- **URL（LAN内）:** `http://kakeibo.local` → :3008, `http://assets.local` → :3009（Avahi + Nginx リバースプロキシ）

### 0.1 統合方針（家計簿と資産管理の並走運用）

- **プロセス分離**：アプリは2プロセス（`kakeibo@3008` / `assets@3009`）。クラッシュや負荷を互いに影響させない。
- **DB分離**：`data/kakeibo.db` と `data/portfolio.db` を完全分離（トランザクション/バックアップも別系統）。
- **UI/コンポーネント共有**：共通UIは npm ワークスペース `packages/ui` として切り出し、両アプリが再利用。
- **Nginx/Avahi**：`kakeibo.local` と `assets.local` にドメイン分離。将来 PWA 化のためにもクッキー/認証境界を明確化。
- **最小インストール**：既存家計簿の構成を踏襲し、資産アプリは必要パッケージのみ追加。Node, npm, SQLite 以外の依存は極小化。

---

## 1. システム要件（非機能）

1. **完全ローカル動作**：既定では外部API通信を行わない。市場価格取得は**明示的に許可**した場合のみ。
2. **固定ポート**：家計簿=3008／資産=3009。対象アプリが固定ポート以外で起動した場合は**即時エラー終了**。
3. **データ永続化**：SQLite（`data/portfolio.db`）。1分間隔の**WAL→checkpoint**で堅牢化。
4. **監査ログ**：全ての作成／更新／削除を`audit_log`テーブルに記録（誰が・いつ・何を・旧→新）。
5. **バックアップ**：アプリ停止時に`/backup/portfolio_YYYY-MM-DD_HHMM.db`へ自動コピー（設定可）。
6. **言語／通貨**：UIは日本語、通貨は JPY 表示が既定。\*\*評価通貨の切替（JPY/USD/CNY）\*\*に対応。
7. **権限**：`viewer`（閲覧のみ） / `admin`（編集可）。未ログイン時は**ダッシュボードのみ**表示。

---

## 2. ドメインモデル（正規化）

### 2.1 共通エンティティ

- **assets**（資産レコードの親）

  - `id` (PK)
  - `class` （`us_stock`|`jp_stock`|`watch`|`precious_metal`|`real_estate`|`collection`|`cash`）
  - `name`（資産名：例「Alphabet C」「Kudoke 2 Indigo」「純金小判 50g」）
  - `note`（備考／品名等）※**空文字""保存ルール**を踏襲
  - `acquired_at`（取得日）
  - `book_value_jpy`（簿価・円換算）
  - `valuation_source`（`manual`|`market_api`|`formula`）
  - `liquidity_tier`（`L1`超流動=現預金/カード枠, `L2`株式, `L3`貴金属/時計, `L4`不動産）
  - `tags`（JSON）

- **valuations**（時価スナップショット）

  - `id` (PK), `asset_id` (FK), `as_of`（日時）, `value_jpy`, `fx_context`（USDJPY, CNYJPY 等）

- **attachments**（領収書・証書・鑑定書 等のファイル参照）

### 2.2 クラス別サブテーブル（抜粋）

- **us\_stocks**: `ticker`, `exchange`, `quantity`, `avg_price_usd`
- **jp\_stocks**: `code`, `quantity`, `avg_price_jpy`
- **watches**: `brand`, `model`, `ref`, `box_papers`(bool)
- **precious\_metals**: `metal`(gold/platinum/silver), `weight_g`, `purity`
- **real\_estates**: `address`, `land_area_sqm`, `building_area_sqm`, `rights`（温泉/鉱泉/持分）
- **collections**: `category`(gunpla/coin/etc), `variant`
- **cashes**: `currency`(JPY/USD/CNY), `balance`

> **投資可能資金の定義**: `liquidity_tier in (L1, L2)`を基準。CNYについては**カード決済枠**を`cash`とは別に`credit_limits`で管理し、**決済可能額**として算入できる設定を提供。

---

## 3. データ連携（**CSV 主体**／Markdownはレポート）

- **取り込み（CSV）**：
  - 既存の `資産物ポートフォリオ管理シート.md` を**一度だけ**正規化→ `data/portfolio.csv` を\*\*正本（canonical）\*\*とする。
  - CSV 変更があれば**ファイルウォッチ**でDBへ即時同期（`import_lock` による排他、差分Upsert）。
- **書き出し**：
  - `GET /api/export?format=csv|md|json` でCSVを基準に生成。Markdownは**レポート用途**（人間可読、編集は非推奨）。
- **CSV 仕様（UTF-8, LF, ヘッダあり）**：

```
class,name,note,acquired_at,book_value_jpy,valuation_source,liquidity_tier,tags,ticker,exchange,quantity,avg_price_usd,code,avg_price_jpy,brand,model,ref,metal,weight_g,purity,address,land_area_sqm,building_area_sqm,category,variant,currency,balance
```

- 未使用カラムは空で可。行ごとに**クラスに必要なカラムのみ**を埋める。
- **競合**：`class+natural_key`（例: `us_stock+ticker` / `watch+brand+model+ref`）で同定。DBが新しければ**DB優先**、`?force=csv` でCSV優先に切替可能。

---

## 4. 価格・為替の取り扱い（オフライン優先）

- 既定：**手動評価**（`manual`）。
- オンデマンド更新（明示的有効化時のみ）:
  - Stocks: Providerプラガブル（Yahoo等／APIキー不要系を優先）。
  - FX: `USDJPY`, `CNYJPY`をキャッシュ付きで取得。
- 失敗時：直近キャッシュを使用し、**UIに明示**（"最終更新: YYYY-MM-DD HH\:mm"）。

---

## 5. 画面仕様

### 5.1 未ログイン（閲覧専用ダッシュボード）

- 合計純資産（NAV）、アセットクラス別配分、月次推移、**高額資産Top3**（**品名/備考の括弧表示ルール**適用：空括弧禁止）。
- 検索・並び替え・CSV出力。

### 5.2 ログイン後（admin）

- **資産一覧**（インライン編集 / 部分更新PATCH / バリデーション）
- **新規登録ウィザード**（クラス選択→必要項目）
- **一括インポート/エクスポート（CSV/MD/JSON）**
- **評価更新**（手動入力／オンデマンド取得）
- **リバランス試算**（目標配分と乖離、売買候補と推定税引後キャッシュ）
- **不動産ユーティリティ**（表面/実質利回り、返済計画、必要表面利回りの逆算）

---

## 6. API（REST）

- `GET /api/assets?class=us_stock`
- `POST /api/assets`（作成）
- `PATCH /api/assets/:id`（**部分更新**; `note`のみ更新可）
- `DELETE /api/assets/:id`
- `POST /api/import/csv` / `GET /api/export?format=csv|md|json`
- `POST /api/valuations/:id/refresh`（明示的有効化時のみの外部取得）
- **認可**: 未ログインは`GET /api/dashboard`のみ。編集系は**401**で拒否。

---

## 7. BDD（抜粋シナリオ）

### 7.1 未ログイン時の挙動

- **Given** 未ログイン
- **When** ルートへアクセス
- **Then** 閲覧専用ダッシュボードのみ。右上に**ログイン**ボタン。編集UIは表示されない。

### 7.2 APIレベルのブロック

- **Given** 未ログイン
- **When** `POST /api/assets` を呼ぶ
- **Then** `401 Unauthorized` を返す。

### 7.3 `note`（品名/備考）の**部分更新**

- **Given** 既存資産の`note`が空文字""
- **When** `PATCH /api/assets/:id { note: "交換レンズ" }`
- **Then** 他の項目を保持したまま`note`のみ更新され、**再読込後も表示が継続**。

### 7.4 高額資産Top3の表示規約

- **Given** `note`がある資産
- **Then** `名称 (note)` 形式で表示。
- **Given** `note`が空文字
- **Then** 括弧を**表示しない**（`()`禁止）。

### 7.5 新規登録（事例：US株）

- **Given** adminログイン
- **When** `ticker=GOOG, quantity=2, avg_price_usd=202.80` を登録
- **Then** 資産一覧と評価に反映（為替計算は直近設定 or 手動入力）。

### 7.6 新規登録（事例：記念金貨）

- **When** `class=collection(category=coin), name=2025日本国際博覧会記念一万円金貨幣, book_value_jpy=268000`
- **Then** コレクションに1点追加。評価は`manual`既定。

### 7.7 インポート（CSV）

- **Given** `data/portfolio.csv` が更新された
- **When** ファイルウォッチャが変更を検知
- **Then** 差分をDBへUpsertし、ダッシュボードに即時反映（`audit_log` に反映件数を記録）。
- **And** CSVが壊れている場合、トランザクションを**ロールバック**し、エラー通知。

### 7.8 ポート固定の検証

- **家計簿**

  - **When** `PORT=3009 node server.js`（家計簿）
  - **Then** 起動せずエラー終了。
  - **When** `node server.js`（家計簿）
  - **Then** `:3008` で待受。

- **資産**

  - **When** `PORT=3008 node server.js`（資産）
  - **Then** 起動せずエラー終了。
  - **When** `node server.js`（資産）
  - **Then** `:3009` で待受。systemd で自動起動。

---

## 8. スキーマ（SQLite）

```sql
-- assets（親）
CREATE TABLE assets (
  id INTEGER PRIMARY KEY,
  class TEXT NOT NULL,
  name TEXT NOT NULL,
  note TEXT NOT NULL DEFAULT "",
  acquired_at TEXT,
  book_value_jpy INTEGER NOT NULL,
  valuation_source TEXT NOT NULL DEFAULT 'manual',
  liquidity_tier TEXT NOT NULL,
  tags TEXT
);

CREATE TABLE valuations (
  id INTEGER PRIMARY KEY,
  asset_id INTEGER NOT NULL,
  as_of TEXT NOT NULL,
  value_jpy INTEGER NOT NULL,
  fx_context TEXT,
  FOREIGN KEY(asset_id) REFERENCES assets(id)
);
-- 例：us_stocks
CREATE TABLE us_stocks (
  asset_id INTEGER PRIMARY KEY,
  ticker TEXT NOT NULL,
  exchange TEXT,
  quantity REAL NOT NULL,
  avg_price_usd REAL NOT NULL,
  FOREIGN KEY(asset_id) REFERENCES assets(id)
);
```

---

## 9. セキュリティ

- ローカルセッション + CSRF対策、パスワードはArgon2でハッシュ。
- **オフライン既定**。市場価格取得を有効にした場合も**プロセス外へデータ送信しない**。

---

## 10. 運用（Ubuntu 24.04）

- **systemd**：
  - `kakeibo.service`（:3008）
  - `assets.service`（:3009）
  - それぞれ `WorkingDirectory`, `ExecStart`, `Environment=PORT=...` を固定。
- **Nginx/Avahi**：
  - `kakeibo.local` → `localhost:3008`
  - `assets.local` → `localhost:3009`
- **バックアップ**：
  - `kakeibo.db` と `portfolio.db` を**個別に**日次ローテーション。
- **CSV 同期**：
  - `inotify` で `data/portfolio.csv` を監視。失敗時は**メール/ログ**通知（ローカルのみ）。

---

## 11. 受け入れ基準（サマリー）

- 未ログイン＝閲覧専用のみ / API編集操作は**401**。
- `note`の**空文字保存**と**部分更新**が**E2E**で通る。
- Top3表示で**空括弧が出ない**ことを**テストで担保**。
- **固定ポート起動拒否テスト**（家計簿=3008／資産=3009）を含む。
- **CSV⇄DB** はラウンドトリップ可能。
- **Markdown** は DB→Markdown の片方向（初回移行のみ MD→CSV/DB ツール提供）。

---

## 12. 今後の拡張

- PWA（スマホ閲覧専用）
- 税レポート（配当・譲渡／特定口座の年間報告書取り込み）
- 目標配分の自動リバランス提案（売買候補と税金見積り）
- リスク分析（相関・ボラティリティ、但しオフラインで計算）

